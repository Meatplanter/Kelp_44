[gd_scene load_steps=6 format=3 uid="uid://biv44gmx22t10"]

[ext_resource type="Texture2D" uid="uid://hccyxo0hsydq" path="res://Assets/bullet.png" id="2_7281b"]
[ext_resource type="Texture2D" uid="uid://dhfjumeo8bx3w" path="res://Assets/tracer.png" id="2_u8st5"]

[sub_resource type="GDScript" id="GDScript_4s4u5"]
script/source = "extends Area2D

var travelledDistance = 0
var bulletSpeed = Global.bulletSpeed
var bulletRange = Global.bulletRange
var bulletContact = 1 - Global.bulletSlowdown
var bulletSlowdown = Global.bulletSlowdown + bulletContact

var bulletEntryPoint = Vector2.ZERO
var bulletEntryDistance
var shootingPoint
var shootingDistance

var bloodTrailScene

func _ready() -> void:
	shootingPoint = global_position
	bulletSpeed = randf_range(0.75*bulletSpeed,1.5*bulletSpeed)
	if Global.bloodTrailScene == true:
		bloodTrailScene = preload(\"res://blood_trail_px.tscn\")
	elif Global.bloodTrailScene == false:
		bloodTrailScene = preload(\"res://blood_trail_pc.tscn\")
		


func _process(delta: float) -> void:
	#get_parent().get_parent().add_child(bloodTrail)
	if Global.gameSpeed == Global.bulletTime:
			$SplatterTimer.set_paused(1)
			$SlomoSplatterTimer.set_paused(0)
	elif Global.gameSpeed == Global.normalTime:
			$SlomoSplatterTimer.set_paused(1)
			$SplatterTimer.set_paused(0)
	
	shootingDistance = clamp(shootingPoint.distance_to(global_position),0,160) #tracer appears only after shooting
	$Tracer.position.x = - shootingDistance
	$SubViewport/Tracer2.position.x = shootingDistance - 162
	
	if $Bullet.is_visible_in_tree() == false: #tracer disappears as bullet enters body
		bulletEntryDistance = bulletEntryPoint.distance_to(global_position)
		$SubViewport.size.x = 160 - (bulletEntryDistance + (160 - shootingDistance))
		
		
		if bulletEntryDistance >= 160:
			queue_free()
	

func _physics_process(delta: float) -> void:
	var direction = Vector2.RIGHT.rotated(rotation)
	position += direction * bulletSpeed * delta * Global.gameSpeed * bulletSlowdown
	if bulletContact == 0.0: bulletSlowdown = bulletSlowdown * Global.bulletSlowdown
	travelledDistance += bulletSpeed * delta * Global.gameSpeed
	
	if travelledDistance > bulletRange*bulletSlowdown:
		Global.bulletsDodged += 1
		queue_free()
		if Global.gameMode == 0:
			Global.currentExp += Global.xp4bullet
	#print(bulletRange*bulletSlowdown,\"  \",bulletSlowdown, \" trav dist \",travelledDistance)
	#print(2/(pow(bulletSlowdown,5)))
	#$SubViewport.size = Vector2(160,3) - Vector2(delta,3)
	

func _on_body_entered(body: Node2D) -> void:
	$Bullet.hide()
	bulletEntryPoint = global_position
	bulletContact = 0.0
	const WOUND = preload(\"res://wound.tscn\")
	var new_wound = WOUND.instantiate()
	if body.has_method(\"take_damage\"):
		body.take_damage()
		body.add_child(new_wound)
		new_wound.global_position = bulletEntryPoint
		

func _on_splatter_timer_timeout() -> void:
	if $Bullet.is_visible_in_tree() == false && Global.bloodTrailVisible == true:
		var bloodTrail = bloodTrailScene.instantiate()
		bloodTrail.rotation_degrees = randf_range(0,360)
		bloodTrail.scale = Vector2(randf_range(0.5,2),randf_range(0.5,2))
		bloodTrail.global_position = self.global_position
		get_parent().add_child(bloodTrail)

func _on_slomo_splatter_timer_timeout() -> void:
	if $Bullet.is_visible_in_tree() == false && Global.bloodTrailVisible == true:
		var bloodTrail = bloodTrailScene.instantiate()
		bloodTrail.rotation_degrees = randf_range(0,360)
		bloodTrail.scale = Vector2(randf_range(0.5,2),randf_range(0.5,2))
		bloodTrail.global_position = self.global_position
		get_parent().add_child(bloodTrail)
"

[sub_resource type="CapsuleShape2D" id="CapsuleShape2D_u8st5"]
radius = 2.0
height = 6.0

[sub_resource type="ViewportTexture" id="ViewportTexture_7281b"]
viewport_path = NodePath("SubViewport")

[node name="Bullet" type="Area2D"]
top_level = true
collision_layer = 3
collision_mask = 3
script = SubResource("GDScript_4s4u5")

[node name="SubViewport" type="SubViewport" parent="."]
transparent_bg = true
size = Vector2i(160, 3)
render_target_update_mode = 4

[node name="Tracer2" type="Sprite2D" parent="SubViewport"]
self_modulate = Color(1, 1, 1, 0.803922)
texture_filter = 1
texture = ExtResource("2_u8st5")
centered = false
offset = Vector2(0, 1)

[node name="Bullet" type="Sprite2D" parent="."]
texture_filter = 1
texture = ExtResource("2_7281b")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(-2, 0)
rotation = 1.5708
shape = SubResource("CapsuleShape2D_u8st5")

[node name="Tracer" type="Sprite2D" parent="."]
texture_filter = 1
position = Vector2(-162, -2)
texture = SubResource("ViewportTexture_7281b")
centered = false
offset = Vector2(0, 0.5)

[node name="SplatterTimer" type="Timer" parent="."]
wait_time = 0.05
autostart = true

[node name="SlomoSplatterTimer" type="Timer" parent="."]
wait_time = 0.5
autostart = true

[connection signal="body_entered" from="." to="." method="_on_body_entered"]
[connection signal="timeout" from="SplatterTimer" to="." method="_on_splatter_timer_timeout"]
[connection signal="timeout" from="SlomoSplatterTimer" to="." method="_on_slomo_splatter_timer_timeout"]
